// This is your Prisma schema file with optimized indexes
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  email     String      @id
  name      String      @db.VarChar(150)
  status    String      @default("active") @db.VarChar(25)
  password  String   @db.VarChar(255)

  // Relations
  loginAccess   LoginAccess[]
  securityLogs  SecurityLog[]
  roles         UserRole[]
  headquarterUser HeadquarterUser[]
  
  // Indexes
  @@index([status]) // Frequent filtering by status
  @@index([status, email]) // Active users search (composite)
}

model LoginAccess {
  loginIdAccess Int     @id @default(autoincrement())
  email         String @db.VarChar(150)
  date          DateTime @default(now())

  user User @relation(fields: [email], references: [email])
  
  // Indexes
  @@index([email]) // Foreign key lookup
  @@index([date]) // Date range searches
  @@index([email, date]) // User access history (composite)
}

model SecurityLog {
  securityIdLog Int      @id @default(autoincrement())
  email         String @db.VarChar(150)
  date          DateTime @default(now())
  action        String @db.VarChar(25)
  description   String @db.VarChar(4000) 
  affectedTable String @db.VarChar(50)

  user User @relation(fields: [email], references: [email])
  
  // Indexes
  @@index([email]) // Foreign key lookup
  @@index([date]) // Date searches
  @@index([affectedTable]) // Filter by affected table
  @@index([action]) // Filter by action type
  @@index([email, date]) // User and date audits (composite)
  @@index([affectedTable, date]) // Table and date audits (composite)
  @@index([affectedTable, action]) // Table and action audits (composite)
}

model Role {
  idRole Int    @id @default(autoincrement())
  rolName String @db.VarChar(50) @unique
  status  String @default("active") @db.VarChar(25)

  users   UserRole[]
  windows RoleWindow[]
  
  // Indexes
  @@index([status]) // Filter by status
}

model Window {
  idWindow   Int    @id @default(autoincrement())
  windowName String @db.VarChar(75) @unique
  status     String @default("active") @db.VarChar(25)

  roles RoleWindow[]
  
  // Indexes
  @@index([status]) // Filter by status
}

model UserRole {
  idRole Int
  email  String @db.VarChar(150)

  role Role @relation(fields: [idRole], references: [idRole])
  user User @relation(fields: [email], references: [email])

  @@id([idRole, email])
  @@index([email]) // Reverse lookup by user
}

model RoleWindow {
  idRole   Int
  idWindow Int
  create   Boolean
  read     Boolean
  update   Boolean
  delete   Boolean

  role   Role   @relation(fields: [idRole], references: [idRole])
  window Window @relation(fields: [idWindow], references: [idWindow])

  @@id([idRole, idWindow])
  @@index([idWindow]) // Reverse lookup by window
}

model Asset {
    idAsset Int @id @default(autoincrement())
    idCategory Int 
    idHeadquarter Int
    name String @db.VarChar(50)
    type String @db.VarChar(50)
    description String @db.VarChar(750)
    status String @db.VarChar(25)
    
    category     Category     @relation(fields: [idCategory], references: [idCategory])
    headquarter  Headquarter  @relation(fields: [idHeadquarter], references: [idHeadquarter])
    
    // Indexes
    @@index([idCategory]) // Category foreign key lookup
    @@index([idHeadquarter]) // Headquarter foreign key lookup
    @@index([status]) // Filter by status
    @@index([type]) // Filter by asset type
    @@index([idHeadquarter, status]) // Assets by headquarter and status (composite)
    @@index([idCategory, status]) // Assets by category and status (composite)
    @@index([idHeadquarter, type]) // Assets by headquarter and type (composite)
}

model Category {
  idCategory Int     @id @default(autoincrement())
  name       String  @db.VarChar(150) @unique
  status     String  @db.VarChar(25)

  asset      Asset[]
  categorySupplier CategorySupplier[]
  
  // Indexes
  @@index([status]) // Filter by status
}

model Supplier {
  idSupplier    Int     @id @default(autoincrement()) 
  name          String  @db.VarChar(150)
  taxId         String?  @db.VarChar(20)
  type          String  @db.VarChar(50)
  email         String  @db.VarChar(150)
  address       String  @db.VarChar(150)
  paymentTerms  String  @db.VarChar(50)
  description   String  @db.VarChar(750)
  status        String  @db.VarChar(25)

  categorySupplier CategorySupplier[]
  headquarterSupplier HeadquarterSupplier[]
  phoneSupplier PhoneSupplier[]
  
  // Indexes
  @@index([status]) // Filter by status
  @@index([email]) // Search by email
  @@index([type]) // Filter by supplier type
  @@index([status, type]) // Active suppliers by type (composite)
}

model Activity {
  idActivity     Int @id @default(autoincrement())
  idHeadquarter  Int
  title          String @db.VarChar(150)
  description    String @db.VarChar(750)
  type           String @db.VarChar(50)
  modality       String @db.VarChar(25)
  capacity       Int
  location       String @db.VarChar(300)
  date           DateTime 
  status         String @default("active") @db.VarChar(25)

  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter]) 
  activityVolunteer ActivityVolunteer[]
  activitySurvivor ActivitySurvivor[]
  activityGodparent ActivityGodparent[]
  
  // Indexes - HIGH PRIORITY
  @@index([idHeadquarter]) // Headquarter foreign key lookup (very frequent)
  @@index([status]) // Filter by status
  @@index([date]) // Search by date
  @@index([type]) // Filter by type
  @@index([modality]) // Filter by modality
  @@index([idHeadquarter, status]) // Active activities by headquarter (composite)
  @@index([idHeadquarter, date]) // Activities by headquarter and date (composite)
  @@index([status, date]) // Active activities by date (composite)
  @@index([type, status]) // Active activities by type (composite)
  @@index([idHeadquarter, status, date]) // Complex searches by headquarter, status and date (composite)
}

model Volunteer {
  idVolunteer    Int    @id @default(autoincrement())
  name           String @db.VarChar(200)
  identifier     String @db.VarChar(30) @unique // ÍNDICE ÚNICO
  country        String @db.VarChar(75)
  birthday       DateTime
  email          String @db.VarChar(80)
  residence      String @db.VarChar(300)
  modality       String @db.VarChar(20)
  institution    String @db.VarChar(100)
  availableSchedule String @db.VarChar(300)
  requiredHours  Int?
  startDate       DateTime
  finishDate      DateTime?
  imageAuthorization Boolean
  notes           String @db.VarChar(250)
  status        String @default("active") @db.VarChar(25)

  phoneVolunteer PhoneVolunteer []
  headquarterVolunteer HeadquarterVolunteer []
  emergencyContactVolunteer EmergencyContactVolunteer []
  activityVolunteer ActivityVolunteer []
  
  // Indexes - HIGH PRIORITY
  // identifier already has automatic unique index
  @@index([email]) // Search by email
  @@index([status]) // Filter by status
  @@index([modality]) // Filter by modality
  @@index([status, modality]) // Active volunteers by modality (composite)
  @@index([status, email]) // Active volunteers by email (composite)
}

model Godparent {
  idGodparent   Int    @id @default(autoincrement())
  idSurvivor    Int?
  idHeadquarter Int
  name          String @db.VarChar(200)
  email         String @db.VarChar(150)
  paymentMethod String @db.VarChar(50)
  startDate     DateTime
  finishDate    DateTime?
  description      String @db.VarChar(250)
  status       String @default("active") @db.VarChar(25)

  godParentsPhone GodparentPhone[]
  activityGodparent ActivityGodparent[]
  survivor Survivor? @relation(fields: [idSurvivor], references: [idSurvivor])
  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  
  // Indexes - HIGH PRIORITY
  @@index([idHeadquarter]) // Headquarter foreign key lookup
  @@index([status]) // Filter by status
  @@index([email]) // Search by email
  @@index([idSurvivor]) // Survivor foreign key lookup
  @@index([idHeadquarter, status]) // Active godparents by headquarter (composite)
  @@index([status, paymentMethod]) // Active godparents by payment method (composite)
}

model EmergencyContact {
  idEmergencyContact Int    @id @default(autoincrement())
  nameEmergencyContact String @db.VarChar(150)
  emailEmergencyContact String @db.VarChar(150)
  relationship       String @db.VarChar(50)
  status             String @default("active") @db.VarChar(25)

  emergencyContactVolunteer EmergencyContactVolunteer[]
  emergencyContactPhone EmergencyContactPhone[]
  emergencyContactSurvivor EmergencyContactSurvivor[]
  
  // Indexes
  @@index([status]) // Filter by status
  @@index([emailEmergencyContact]) // Search by email
}

model Survivor {
  idSurvivor    Int    @id @default(autoincrement())
  idHeadquarter Int
  survivorName  String @db.VarChar(200)
  documentNumber String @db.VarChar(30) @unique // ÍNDICE ÚNICO
  country       String @db.VarChar(75)
  birthday      DateTime
  email         String @db.VarChar(150)
  residence     String @db.VarChar(300)
  genre         String @db.VarChar(25)
  workingCondition String @db.VarChar(50)
  CONAPDIS      Boolean
  IMAS          Boolean
  physicalFileStatus String @db.VarChar(25)
  medicalRecord  String @db.VarChar(25)
  dateHomeSINRUBE String @db.VarChar(25)
  foodBank       String @db.VarChar(25)
  socioEconomicStudy String @db.VarChar(25)
  notes          String? @db.VarChar(250)
  status       String @default("active") @db.VarChar(25)

  emergencyContactSurvivor EmergencyContactSurvivor[]
  phoneSurvivor PhoneSurvivor[]
  activitySurvivor ActivitySurvivor[]
  cancerSurvivor CancerSurvivor[]
  godparent       Godparent[]
  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  
  // Indexes - HIGH PRIORITY
  // documentNumber already has automatic unique index
  @@index([idHeadquarter]) // Headquarter foreign key lookup (very frequent)
  @@index([status]) // Filter by status
  @@index([email]) // Search by email
  @@index([genre]) // Filter by genre
  @@index([idHeadquarter, status]) // Active survivors by headquarter (composite)
  @@index([status, genre]) // Active survivors by genre (composite)
  @@index([idHeadquarter, genre]) // Survivors by headquarter and genre (composite)
}

model Cancer {
  idCancer    Int    @id @default(autoincrement())
  cancerName String @db.VarChar(100) @unique
  description String @db.VarChar(300)
  status     String @default("active") @db.VarChar(25)

  cancerSurvivor CancerSurvivor[]
  
  // Indexes
  @@index([status]) // Filter by status
}

model Phone {
  idPhone       Int @id @default(autoincrement())
  phone         Int @unique // UNIQUE INDEX to avoid duplicates

  phoneVolunteers PhoneVolunteer[]
  phoneSurvivor   PhoneSurvivor[]
  emergencyContactPhone EmergencyContactPhone[]
  headquarterPhone HeadquarterPhone[]
  godparentPhone GodparentPhone[]
  phoneSupplier PhoneSupplier[]
}

model Headquarter {
  idHeadquarter Int    @id @default(autoincrement())
  name           String @db.VarChar(150) @unique
  schedule       String @db.VarChar(300)
  location       String @db.VarChar(300)
  email          String @db.VarChar(150)
  description    String @db.VarChar(750)
  status         String @default("active") @db.VarChar(25)

  activities     Activity[]
  headquarterUser HeadquarterUser[]
  headquarterVolunteer HeadquarterVolunteer[]
  headquarterPhone HeadquarterPhone[]
  godparent Godparent[]
  survivor Survivor[]
  asset Asset[]
  headquarterSupplier HeadquarterSupplier[]
  
  // Indexes
  @@index([status]) // Filter by status
  @@index([email]) // Search by email
}

// RELATIONAL TABLES
model HeadquarterUser {
  idHeadquarter Int
  email          String @db.VarChar(150)

  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  user         User         @relation(fields: [email], references: [email])

  @@id([idHeadquarter, email])
  @@index([email]) // Reverse lookup by user
}

model HeadquarterVolunteer {
  idHeadquarter Int
  idVolunteer   Int

  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  volunteer   Volunteer   @relation(fields: [idVolunteer], references: [idVolunteer])

  @@id([idHeadquarter, idVolunteer])
  @@index([idVolunteer]) // Reverse lookup by volunteer
}

model HeadquarterPhone {
  idHeadquarter Int
  idPhone       Int

  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  phone       Phone       @relation(fields: [idPhone], references: [idPhone])

  @@id([idHeadquarter, idPhone])
  @@index([idPhone]) // Reverse lookup by phone
}

model PhoneSurvivor {
  idPhone       Int
  idSurvivor    Int

  phone    Phone    @relation(fields: [idPhone], references: [idPhone])
  survivor Survivor @relation(fields: [idSurvivor], references: [idSurvivor])

  @@id([idPhone, idSurvivor])
  @@index([idSurvivor]) // Reverse lookup by survivor
}

model PhoneVolunteer {
  idPhone      Int
  idVolunteer  Int

  phone     Phone     @relation(fields: [idPhone], references: [idPhone])
  volunteer Volunteer @relation(fields: [idVolunteer], references: [idVolunteer])

  @@id([idPhone, idVolunteer])
  @@index([idVolunteer]) // Reverse lookup by volunteer
} 

model GodparentPhone {
  idGodparent Int
  idPhone     Int

  godparent Godparent @relation(fields: [idGodparent], references: [idGodparent])
  phone     Phone     @relation(fields: [idPhone], references: [idPhone])

  @@id([idGodparent, idPhone])
  @@index([idPhone]) // Reverse lookup by phone
}

model ActivityVolunteer {
  idActivity   Int
  idVolunteer  Int

  activity  Activity  @relation(fields: [idActivity], references: [idActivity])
  volunteer Volunteer @relation(fields: [idVolunteer], references: [idVolunteer])

  @@id([idActivity, idVolunteer])
  @@index([idVolunteer]) // Reverse lookup by volunteer
}

model ActivityGodparent {
  idActivity  Int
  idGodparent Int

  activity  Activity  @relation(fields: [idActivity], references: [idActivity])
  godparent Godparent @relation(fields: [idGodparent], references: [idGodparent])

  @@id([idActivity, idGodparent])
  @@index([idGodparent]) // Reverse lookup by godparent
}

model ActivitySurvivor {
  idActivity  Int
  idSurvivor  Int

  activity Activity @relation(fields: [idActivity], references: [idActivity])
  survivor Survivor @relation(fields: [idSurvivor], references: [idSurvivor])

  @@id([idActivity, idSurvivor])
  @@index([idSurvivor]) // Reverse lookup by survivor
}

model EmergencyContactVolunteer {
  idEmergencyContact Int
  idVolunteer        Int

  emergencyContact EmergencyContact @relation(fields: [idEmergencyContact], references: [idEmergencyContact])
  volunteer        Volunteer        @relation(fields: [idVolunteer], references: [idVolunteer])

  @@id([idEmergencyContact, idVolunteer])
  @@index([idVolunteer]) // Reverse lookup by volunteer
}

model EmergencyContactSurvivor {
  idEmergencyContact Int
  idSurvivor         Int

  emergencyContact EmergencyContact @relation(fields: [idEmergencyContact], references: [idEmergencyContact])
  survivor         Survivor         @relation(fields: [idSurvivor], references: [idSurvivor])

  @@id([idEmergencyContact, idSurvivor])
  @@index([idSurvivor]) // Reverse lookup by survivor
}

model EmergencyContactPhone {
  idEmergencyContact Int
  idPhone            Int

  emergencyContact EmergencyContact @relation(fields: [idEmergencyContact], references: [idEmergencyContact])
  phone            Phone            @relation(fields: [idPhone], references: [idPhone])

  @@id([idEmergencyContact, idPhone])
  @@index([idPhone]) // Reverse lookup by phone
}

model CancerSurvivor {
  idCancer   Int
  idSurvivor Int
  status     String
  aftermath  String

  cancer   Cancer   @relation(fields: [idCancer], references: [idCancer])
  survivor Survivor @relation(fields: [idSurvivor], references: [idSurvivor])

  @@id([idCancer, idSurvivor])
  @@index([idSurvivor]) // Reverse lookup (get all cancers of a survivor)
  @@index([idCancer, status]) // Filter survivors by cancer type and status (composite)
}

model CategorySupplier {
  idCategory Int
  idSupplier Int

  category Category @relation(fields: [idCategory], references: [idCategory])
  supplier Supplier @relation(fields: [idSupplier], references: [idSupplier])

  @@id([idCategory, idSupplier])
  @@index([idSupplier]) // Reverse lookup by supplier
}

model PhoneSupplier {
  idPhone    Int
  idSupplier Int

  phone    Phone    @relation(fields: [idPhone], references: [idPhone])
  supplier Supplier @relation(fields: [idSupplier], references: [idSupplier])

  @@id([idPhone, idSupplier])
  @@index([idSupplier]) // Reverse lookup by supplier
}

model HeadquarterSupplier {
  idHeadquarter Int
  idSupplier    Int

  headquarter Headquarter @relation(fields: [idHeadquarter], references: [idHeadquarter])
  supplier     Supplier     @relation(fields: [idSupplier], references: [idSupplier])

  @@id([idHeadquarter, idSupplier])
  @@index([idSupplier]) // Reverse lookup by supplier
}

model TokenBlacklist {
  id        Int      @id @default(autoincrement())
  token     String   @db.Text
  createdAt DateTime @default(now())
  
  // Indexes
  @@index([token(length: 255)]) // Index on token (limited to 255 characters for TEXT)
  @@index([createdAt]) // Periodic cleanup of old tokens
}
